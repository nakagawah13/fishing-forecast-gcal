---
applyTo: "**"
---

# AI Pull Request Instructions

このガイドラインは、**AIがPRを作成・更新する際の統一ルール**を定義します。

## このファイルの役割と適用範囲

### 目的

AIがPull Request（PR）を作成・更新する際に、一貫性のある高品質なPRを生成するための必須要件とフォーマット規則を定義します。

### 適用範囲

- **対象**: AIによるPR作成・更新のすべて
- **適用タイミング**: PRの新規作成、既存PRの更新、PRテンプレートの生成
- **対象プロジェクト**: ML/AIプロジェクト、一般的なソフトウェアプロジェクト

### 関連ガイドライン

- **Gitワークフロー**: [git-workflow.instructions.md](./git-workflow.instructions.md) - ブランチ戦略、コミット規約
- **ML実験管理**: [git-workflow-ml-experiments.instructions.md](./git-workflow-ml-experiments.instructions.md) - 実験レビュー観点
- **コード品質**: [ai-code-writing.instructions.md](./ai-code-writing.instructions.md) - コードスタイル

---

## PRフォーマット規則 (MUST)

AIがPR本文を記述する際、以下のフォーマット規則を**必ず遵守**してください。

| 観点 | ルール |
|------|--------|
| 改行 | 実際の改行文字を使用する。`\n` などのエスケープシーケンスは使用しない |
| 箇条書き | 先頭は `-` + 半角スペース。入れ子は 2 スペースインデント |
| コード・識別子 | バッククォート（`` ` ``）で囲む。例: `DataValidator`, `config/schema.json` |
| 英数字と日本語の間 | 半角スペースを入れる。例: `DataValidator クラス`, `15 件を追加` |
| 一人称 | 使用しない。「本PR」「この変更」等の表現を避け、客観的に記述 |
| 絵文字 | 使用を最小限に。公式表現を優先（✅ Pass, ❌ Fail は許容） |
| 段落間の空行 | セクション間、箇条書きグループ間には 1 行の空行を入れる |
| 表形式 | ヘッダー行、区切り行、データ行の順。列は `|` で区切る |

**良い例**:
```markdown
- `DataValidator` クラスを新規実装
- スキーマ定義ファイル (`config/schema.json`) を追加
  - 必須カラム: `timestamp`, `value`, `label`
  - オプションカラム: `metadata`
- 既存の `DataLoader` クラスにバリデーション呼び出しを統合
```

**悪い例**:
```markdown
- DataValidatorクラスを新規実装\n（バッククォートなし、\nが文字として表示）
- 本PRでスキーマ定義ファイル(config/schema.json)を追加しました（一人称使用、スペースなし）
  ・必須カラム: timestamp, value, label（入れ子が2スペースでない）
```

### アンチパターン（禁止事項）

以下のパターンは**使用禁止**です。PR本文に含めないでください。

| アンチパターン | 問題点 | 回避指針 |
|---------------|--------|----------|
| コミットメッセージの全文掲載 | 冗長で可読性が低下。変更履歴は `git log` で確認可能 | 変更概要セクションに要約のみ記載 |
| 未来時制での確約表現 | 推測が混入し、実装状況が不明確になる。例: 「〜を実装予定」 | 「今後の予定」セクションまたはIssue参照で列挙 |
| 仕様文書の全文貼り付け | 情報過多でレビュー効率が低下 | 仕様書へのリンクのみ記載 |
| 未実施テストをPassと表記 | 誤情報となり信頼性を損なう | `N/A`（未実施）と表記し、理由を簡潔に説明 |
| スクリーンショットの過剰使用 | ファイルサイズ増大、差分確認が困難 | 必要最小限に。動作はテストコードで検証 |
| 関係ない変更の混入 | レビュー対象が不明確になる | 別PRに分離。純粋な関心事の分離を守る |

**禁止例**:

```markdown
❌ コミットメッセージの全文掲載
## 変更概要
以下のコミットを実施しました：
- feat: add data validation (commit abc123)
  Add DataValidator class with schema validation...
  （コミットメッセージ本文を丸ごと掲載）

✅ 正しい記載
## 変更概要
- `DataValidator` クラスを新規実装
- スキーマ定義ファイルを追加
```

```markdown
❌ 未来時制での確約
## 変更概要
- データバリデーション機能を実装予定
- エラーハンドリングを追加予定

✅ 正しい記載
## 変更概要
- データバリデーション機能を実装

## 今後の予定
- エラーハンドリングの拡張（Issue #345）
```

```markdown
❌ 未実施テストをPassと表記
| 種別 | 対象 | 結果 |
|------|------|------|
| E2Eテスト | 全シナリオ | ✅ Pass |

（実際には未実施）

✅ 正しい記載
| 種別 | 対象 | 結果 |
|------|------|------|
| E2Eテスト | 全シナリオ | N/A（環境構築中、次PRで実施予定） |
```

---

## PRタイトル規則 (MUST)

### 形式

```
<type>[optional scope]: <description>
```

### ルール

| 項目 | ルール |
|------|--------|
| 形式 | Conventional Commits準拠 |
| 言語 | 英語 |
| 文字数 | 50文字以内 |
| 大文字/小文字 | `<description>` は小文字で開始 |
| 終端 | ピリオドなし |
| 時制 | 命令形（"add" not "added"） |

### `<type>` の種類

| タイプ | 用途 |
|--------|------|
| `feat` | 新機能の追加 |
| `fix` | バグ修正 |
| `docs` | ドキュメントのみの変更 |
| `style` | コードスタイル変更（動作に影響なし） |
| `refactor` | リファクタリング |
| `perf` | パフォーマンス改善 |
| `test` | テストの追加・修正 |
| `build` | ビルドシステム・依存関係の変更 |
| `ci` | CI設定の変更 |
| `chore` | その他の変更 |
| `model` | モデル開発・改善（ML/AI） |
| `train` | 訓練パイプライン変更（ML/AI） |
| `eval` | 評価・検証（ML/AI） |
| `data` | データ処理・前処理（ML/AI） |

### 例

```
feat: add automated model retraining pipeline
fix(validator): handle empty dataframe error
docs: update API specification for inference endpoint
model: implement LightGBM classifier with feature engineering
```

---

## PR本文の必須セクション (MUST)

PR本文には以下のセクションを**必ず**含めてください。見出しは見出し2(##)を最大とし、詳細項目は見出し3(###)を使用します。

### 1. 変更概要（What）

**目的**: 何を変更したかを簡潔に伝える

**形式**:
- 箇条書きで記述
- 主要な変更点を3-5項目程度
- 技術的な詳細より変更の要点を重視

**例**:
```markdown
## 変更概要

- データバリデーション機能を `DataValidator` クラスとして実装
- スキーマ定義ファイル (`config/schema.json`) を追加
- 既存の `DataLoader` クラスにバリデーション呼び出しを統合
- ユニットテスト15件を追加
```

---

### 2. 変更理由（Why）

**目的**: なぜこの変更が必要かを説明する

**形式**:
- 背景・課題・動機を記述
- ビジネス要件や技術的負債との関連を明記
- 関連するIssueやディスカッションがあればリンク

**例**:
```markdown
## 変更理由

不正なデータが推論パイプラインに流入し、モデル精度が低下する問題が発生していた。
入力段階でデータを検証し、異常値を早期に検出する仕組みが必要。

関連Issue: #234
```

---

### 3. タスク対応

**目的**: 計画（implementation_plan.md等）に対する進捗状況を明示する

**形式**:
- 表形式で記述
- タスクID、Epic、状態（Before → After）、概要を含む
- 状態の変更が明確にわかるようにする

**例**:
```markdown
## タスク対応

| Task ID | Epic | 状態 (Before → After) | 概要 |
|---------|------|----------------------|------|
| T-001 | データ品質 | 🔵 In Progress → ✅ Done | DataValidatorクラス実装 |
| T-002 | データ品質 | ⚪ Not Started → 🔵 In Progress | スキーマ定義の拡張 |
| T-003 | 推論改善 | ⚪ Not Started → ⚪ Not Started | 変更なし |

**更新対象ファイル**: `docs/implementation_plan.md`
```

**状態アイコン凡例**:
- ⚪ Not Started（未着手）
- 🔵 In Progress（進行中）
- ✅ Done（完了）
- ⏸️ Blocked（ブロック中）
- ❌ Cancelled（キャンセル）

---

### 4. 影響範囲

**目的**: 変更がどのファイル・モジュール・機能に影響するかを明示する

**形式**:
- 影響を受けるモジュール・ファイルをリスト
- 依存関係の変更があれば記載
- 設定ファイルの変更があれば明記

**例**:
```markdown
## 影響範囲

- **変更ファイル**:
  - `python-trainer/src/trainer/data_loader.py` - バリデーション呼び出し追加
  - `python-trainer/src/trainer/validator.py` - 新規作成
  - `config/schema.json` - 新規作成

- **依存モジュール**:
  - `preprocessor.py` - DataLoaderを使用（動作確認済み）
  - `model_trainer.py` - DataLoaderを使用（動作確認済み）

- **設定変更**:
  - `config/app_settings.json` に `validation.enabled` オプションを追加
```

---

### 5. テスト / 検証

**目的**: 実施したテストの種別と結果を報告する

**形式**:
- 表形式で記述
- 種別、対象、結果を含む
- 失敗がある場合は原因と次アクションを1-2行で記載

**例（すべて成功）**:
```markdown
## テスト / 検証

| 種別 | 対象 | 結果 |
|------|------|------|
| ユニットテスト | `test_validator.py` (15件) | ✅ Pass |
| 統合テスト | データパイプライン全体 | ✅ Pass |
| 手動テスト | 異常データ入力時の挙動 | ✅ Pass |
| Lint | ruff check | ✅ Pass |
| 型チェック | mypy | ✅ Pass |
```

**例（失敗あり）**:
```markdown
## テスト / 検証

| 種別 | 対象 | 結果 |
|------|------|------|
| ユニットテスト | `test_validator.py` (15件) | ✅ Pass |
| 統合テスト | データパイプライン全体 | ❌ Fail |
| Lint | ruff check | ✅ Pass |

**失敗の詳細**:

**統合テスト失敗**:
- 原因: 大容量データ（100万行以上）でメモリ不足が発生
- 次アクション: チャンク処理の実装を次PRで対応（Issue #567 作成済み）
```

---

### 6. リスク / 互換性

**目的**: 破壊的変更の有無と影響範囲を明示する

**形式**:
- 破壊的変更（Breaking Changes）の有無を明記
- ある場合は具体的な影響と移行方法を記載
- 後方互換性に関する情報を含む

**例（破壊的変更なし）**:
```markdown
## リスク / 互換性

| 項目 | 状態 |
|------|------|
| 破壊的変更 | なし |
| 後方互換性 | 維持 |
| API変更 | なし |
| 設定ファイル変更 | あり（オプション追加のみ、既存動作に影響なし） |
```

**例（破壊的変更あり）**:
```markdown
## リスク / 互換性

| 項目 | 状態 |
|------|------|
| 破壊的変更 | **あり** |
| 後方互換性 | 非互換 |
| API変更 | レスポンス形式変更（CSV → JSON） |

**破壊的変更の詳細**:

変更内容: 推論APIのレスポンス形式がCSVからJSONに変更

Before:
```csv
timestamp,value,prediction
2025-12-06T10:00:00,42.5,0
```

After:
```json
{"timestamp": "2025-12-06T10:00:00", "value": 42.5, "prediction": 0}
```

移行方法:
1. クライアント側のパーサーをJSON対応に更新
2. `Accept: application/json` ヘッダーを追加
3. 移行期間（2週間）は `?format=csv` パラメータで旧形式も利用可能
```

---

### 7. 関連Issue / PR（任意）

**目的**: 関連するIssueやPRへの参照を記載する

**形式**:
- `Closes #123` - マージ時にIssueを自動クローズ
- `Refs #456` - 関連Issueへの参照（クローズしない）
- `Related PR: #789` - 関連PRへの参照

**例**:
```markdown
## 関連Issue / PR

- Closes #234 - データバリデーション機能の実装
- Refs #123 - データ品質改善プロジェクト
- Related PR: #456 - スキーマ定義の設計ドキュメント
```

---

### 8. 実験結果（ML/AI関連PRのみ・必須）

**目的**: モデル精度・評価指標とベースラインとの比較を報告する

**適用条件**:
- `model/`, `train/`, `eval/`, `data/` タイプのPRで必須
- 一般的なソフトウェア変更PRでは省略可

**形式**:
- 評価指標を表形式で記載
- ベースラインとの比較を含む
- 再現性情報（シード、データセット期間、タグ）を明記

**例**:
```markdown
## 実験結果

**目的**: 不良品検出精度の向上

**評価指標**:

| モデル | Accuracy | Precision | Recall | F1 |
|--------|----------|-----------|--------|-----|
| Baseline (v1.0) | 82.3% | 80.1% | 84.2% | 82.1% |
| **Proposed** | **85.5%** | **83.4%** | **87.8%** | **85.5%** |
| 改善幅 | +3.2% | +3.3% | +3.6% | +3.4% |

**考察**:
- lag特徴量の追加が時系列パターンの捕捉に寄与
- false positiveが15%減少し、実運用での誤報削減が期待される
- 推論時間は平均2ms増加（許容範囲内）

**再現性情報**:
- Random Seed: 42
- Dataset: 2025-12-01 to 2025-12-05
- Train/Test Split: 80/20
- Git Tag: `exp-lag-features-v1`
```

---

## PR作成時の自動チェック (MUST)

AIがPRを作成する際、以下のチェックを**必ず実行**してください。

### 1. コミット整合チェック

| チェック項目 | 確認内容 | 対処 |
|-------------|----------|------|
| コミット漏れ | `git status` でunstaged/untracked filesがないか | 必要なファイルをコミット |
| ブランチ同期 | mainブランチとの差分が意図通りか | `git diff main` で確認 |
| コンフリクト | mainとのコンフリクトがないか | 事前にリベースして解決 |
| コミットメッセージ | Conventional Commits準拠か | 非準拠の場合は `--amend` で修正 |

### 1-2. タスク・コミット整合チェック（AI内部検証）

PR作成時に以下を内部チェックし、**欠落があればPR本文にWARNINGブロックを挿入**してください:

| チェック項目 | 確認内容 | WARNING条件 |
|-------------|----------|------------|
| タスク存在確認 | 実装対象Taskが`implementation_plan.md`に存在するか | タスクIDが見つからない場合 |
| タスク状態確認 | Task状態がDone（✅）であるか | WIP/Blockedの場合は明示が必要 |
| 構造違反チェック | 追加ファイルがガイドライン禁止構造に違反しないか | 重複ディレクトリ、禁止パターンの場合 |
| テストファイル確認 | テストファイルが1つ以上追加/変更されているか | 純ドキュメントPR以外でテストがない場合 |
| 変更要約確認 | 主要モジュール変更に対する要約が1行以上存在するか | 影響範囲セクションが空または不十分な場合 |

**WARNING挿入例**:

```markdown
> ⚠️ **WARNING**: implementation_plan.mdにタスクID `T-008` が見つかりません。
> タスクID表記ゆれを確認してください。

> ⚠️ **WARNING**: コード変更がありますが、テストファイルの追加/変更が検出されませんでした。
> テストの追加を検討してください。

> ⚠️ **WARNING**: `src/utils/` ディレクトリが新規作成されていますが、
> 既存の `src/utilities/` と重複する可能性があります。
> [ai-project-structure-core.instructions.md](../../.github/instructions/ai-project-structure-core.instructions.md) を確認してください。
```

### 2. コード品質チェック

| チェック項目 | コマンド例 | 対処 |
|-------------|-----------|------|
| Lint | `ruff check .` | エラーを修正してからPR作成 |
| 型チェック | `mypy` | 型エラーを修正 |
| テスト | `pytest` | 失敗テストを修正または理由を記載 |
| フォーマット | `ruff format --check .` | 自動フォーマット適用 |

#### テスト結果の収集方法

AIは以下の優先順でテスト結果を取得し、PR本文に整形してください:

1. **直前実行結果のキャッシュ**: 既にpytestを実行済みの場合、その集計結果を利用
2. **高速再実行**: `pytest -q --maxfail=1` で最初の失敗まで実行（時間節約）
3. **失敗詳細の要約**: 失敗がある場合は**1ケースのみ**本文に詳細を記載し、他はログファイル参照を誘導

### 3. ドキュメント整合チェック

| チェック項目 | 確認内容 | 対処 |
|-------------|----------|------|
| README更新 | 機能追加時にREADMEが更新されているか | 必要に応じて更新 |
| API仕様 | API変更時に `docs/api_specification.md` が更新されているか | 仕様書を更新 |
| 設定ファイル | 設定追加時に説明が記載されているか | コメントまたはドキュメント追加 |
| implementation_plan.md | タスク状態が更新されているか | 状態を更新 |

### 4. ML/AI固有チェック（該当する場合）

| チェック項目 | 確認内容 | 対処 |
|-------------|----------|------|
| 再現性 | 乱数シードが固定されているか | コード内でシード設定を確認 |
| 依存関係 | `requirements.txt` が更新されているか | 新規ライブラリを追加 |
| 実験設定 | 設定ファイルがコミットされているか | `config/experiment_*.json` を確認 |
| タグ | 重要な実験にタグが付けられているか | `git tag -a` でタグ作成 |

---

## PR例

### ML/AIモデル改善PR

```markdown
# model: improve defect detection with lag features

## 変更概要

- 時系列lag特徴量（lag_1, lag_2, lag_3）を追加
- LightGBMハイパーパラメータを調整（learning_rate: 0.1 → 0.05）
- 特徴量重要度の可視化を追加
- 実験設定ファイルを追加

## 変更理由

ベースラインモデルでは時系列パターンを十分に捉えられていなかった。
lag特徴量の導入により、直前の測定値との関係性をモデルに学習させる。

## タスク対応

| Task ID | Epic | 状態 (Before → After) | 概要 |
|---------|------|----------------------|------|
| T-010 | モデル改善 | 🔵 In Progress → ✅ Done | lag特徴量実装 |
| T-011 | モデル改善 | ⚪ Not Started → ✅ Done | ハイパーパラメータ調整 |
| T-012 | 評価 | ⚪ Not Started → 🔵 In Progress | 長期lagの検証 |

**更新対象ファイル**: `docs/implementation_plan.md`

## 影響範囲

### 変更ファイル
- `python-trainer/src/trainer/preprocessor.py` - lag特徴量生成追加
- `python-trainer/src/trainer/model_trainer.py` - ハイパーパラメータ変更
- `config/experiment_lag_features.json` - 新規作成

### 依存モジュール
- `data_loader.py` - 影響なし
- `onnx_converter.py` - 特徴量数変更により更新必要（対応済み）

## テスト / 検証

| 種別 | 対象 | 結果 |
|------|------|------|
| ユニットテスト | preprocessor (8件) | ✅ Pass |
| モデル訓練 | LightGBM | ✅ Pass |
| 推論テスト | ONNX export | ✅ Pass |
| Lint | ruff check | ✅ Pass |

## リスク / 互換性

| 項目 | 状態 |
|------|------|
| 破壊的変更 | **あり**（モデル入力特徴量数が変更） |
| 後方互換性 | 非互換（新モデルには新特徴量が必要） |
| 移行方法 | 推論時にlag特徴量を計算するよう `InferenceService` を更新済み |

## 実験結果

### 目的
不良品検出精度の向上

### 評価指標

| モデル | Accuracy | Precision | Recall | F1 |
|--------|----------|-----------|--------|-----|
| Baseline (v1.0) | 82.3% | 80.1% | 84.2% | 82.1% |
| **Proposed** | **85.5%** | **83.4%** | **87.8%** | **85.5%** |
| 改善幅 | +3.2% | +3.3% | +3.6% | +3.4% |

### 考察
- lag特徴量が時系列パターンの捕捉に寄与
- false positiveが15%減少
- 推論時間は平均2ms増加（許容範囲内）

### 再現性情報
- **Random Seed**: 42
- **Dataset**: 2025-12-01 to 2025-12-05
- **Train/Test Split**: 80/20
- **Git Tag**: `exp-lag-features-v1`

## 関連Issue / PR

- Closes #345 - lag特徴量による精度改善
- Refs #300 - モデル改善プロジェクト
```

---

## AI実装手順（内部用）

AIがPRを自動生成する際の推奨実装手順です。

### ステップ1: 変更差分の収集と分析

```bash
# 1-1. 変更ファイルリストの取得
git diff --name-only origin/main...HEAD

# 1-2. 変更内容の統計情報
git diff origin/main...HEAD --stat

# 1-3. 変更内容の要約（追加/削除行数、主要な変更箇所）
git diff origin/main...HEAD --numstat
```

**収集する情報**:
- 変更されたファイルのパスリスト
- 各ファイルの追加/削除行数
- 新規作成ファイル（git status --short で `A` マーク）
- 削除ファイル（git status --short で `D` マーク）

### ステップ2: タスク情報の抽出

```bash
# 2-1. implementation_plan.md からタスク情報を抽出
grep -E "^\| T-[0-9]+" docs/implementation_plan.md
```

**収集する情報**:
- タスクID（T-XXX）
- Epic名
- 現在の状態（⚪ / 🔵 / ✅ / ⏸️ / ❌）
- タスク概要

**状態判定ロジック**:
- コミットメッセージやファイル変更から該当タスクを推定
- タスク状態が `✅ Done` でない場合は WARNING を生成

### ステップ3: コード品質チェックの実行

```bash
# 3-1. Lintチェック
ruff check . 2>&1

# 3-2. フォーマットチェック
ruff format --check . 2>&1

# 3-3. 型チェック（Python）
mypy . 2>&1

# 3-4. テスト実行
pytest --tb=short -q 2>&1
```

**結果の整形**:
- 各チェックの成功/失敗を判定
- 失敗がある場合は最初の1件のみ詳細を抽出
- 残りはログファイル参照を誘導

### ステップ4: 影響範囲の分析

```bash
# 4-1. 変更ファイルから import 文を抽出
for file in $(git diff --name-only origin/main...HEAD | grep '\.py$'); do
  grep -E "^(from|import) " "$file"
done

# 4-2. 変更ファイルを使用している他のファイルを検索
grep -r "import.*<module_name>" --include="*.py"
```

**収集する情報**:
- 変更ファイルが依存しているモジュール
- 変更ファイルを使用している他のモジュール
- 設定ファイルの変更（`config/*.json`）

### ステップ5: WARNING条件のチェック

**チェック項目**:

1. **タスク存在確認**:
   ```python
   # 変更内容から推定されるタスクIDがimplementation_plan.mdに存在するか
   if task_id not in implementation_plan_tasks:
       generate_warning(f"タスクID {task_id} が見つかりません")
   ```

2. **テストファイル確認**:
   ```bash
   # テストファイルの追加/変更があるか
   git diff --name-only origin/main...HEAD | grep -E "(test_|_test\.py|Test\.java)"
   ```
   
   - ドキュメントのみの変更（`docs/**`, `*.md`）は除外
   - それ以外でテストがない場合は WARNING

3. **構造違反チェック**:
   ```bash
   # 新規ディレクトリが禁止パターンに該当しないか
   git diff --name-only origin/main...HEAD | grep -E "(temp/|tmp/|test_folder/|misc/|other/)"
   ```

4. **変更要約確認**:
   - 影響範囲セクションに最低1つのファイル説明があるか

### ステップ6: 実験結果の抽出（ML/AI PRのみ）

**適用条件**: PRタイプが `model/`, `train/`, `eval/`, `data/` の場合

```bash
# 6-1. 実験ログファイルを検索
find experiments/ mlruns/ -name "*.json" -o -name "*.yaml" -mtime -7

# 6-2. 評価指標を抽出
# 例: experiments/exp_XXX/metrics.json から accuracy, precision, recall, f1 を抽出
```

**収集する情報**:
- 評価指標（Accuracy, Precision, Recall, F1）
- ベースラインとの比較データ
- 再現性情報（Random Seed, Dataset期間、Git Tag）

### ステップ7: PR本文の生成

**手順**:

1. **テンプレート読み込み**:
   ```python
   # .github/pull_request_template.md をベースとして読み込む
   # （人間用テンプレートをAIが参照）
   ```

2. **各セクションの埋め込み**:
   - **変更概要**: ステップ1の差分情報から自動生成
   - **変更理由**: コミットメッセージや関連Issueから推定
   - **タスク対応**: ステップ2のタスク情報を表形式で挿入
   - **影響範囲**: ステップ4の分析結果を構造化
   - **テスト / 検証**: ステップ3の結果を表形式で挿入
   - **実験結果**: ステップ6の実験データを挿入（ML/AI PRのみ）

3. **WARNING挿入**:
   - ステップ5で検出された問題をPR本文の先頭に挿入
   ```markdown
   > ⚠️ **WARNING**: <検出された問題>
   ```

4. **禁止パターン検査**:
   - コミットメッセージの全文掲載がないか
   - 未来時制の表現がないか
   - 未実施テストをPassと表記していないか

5. **自己検証の実施**:
   - 生成したPR本文が全てのフォーマット規則に準拠しているか確認
   - 違反が検出された場合は修正して再検証（最大3回）

### ステップ8: 自己検証チェック

生成直後に以下を確認し、違反があれば**該当箇所を修正**してください：

**フォーマット違反チェック**:
- [ ] `\n` などのエスケープシーケンスが含まれていない
- [ ] 識別子がバッククォート（`` ` ``）で囲まれている
- [ ] 英数字と日本語の間に半角スペースがある
- [ ] 箇条書きの入れ子が2スペースインデント
- [ ] 一人称（「本PR」「この変更」等）を使用していない

**アンチパターンチェック**:
- [ ] コミットメッセージの全文を掲載していない
- [ ] 未来時制（「〜予定」「〜します」）を使用していない
- [ ] 未実施テストを「✅ Pass」と表記していない
- [ ] 仕様文書の全文を貼り付けていない

**必須セクションチェック**:
- [ ] 変更概要、変更理由、タスク対応、影響範囲、テスト / 検証、リスク / 互換性の6セクションが存在
- [ ] ML/AI PRの場合、実験結果セクションが存在
- [ ] 各セクションに具体的な内容が記載されている（空でない）

**修正プロセス**:
1. チェックリストで違反を特定
2. 該当箇所をガイドラインに沿って修正
3. 修正後、再度チェックリストを確認
4. 3回の修正試行後も違反が残る場合、人間の確認を推奨するコメントを追加

### ステップ9: PR作成/更新

```bash
# 8-1. GitHub CLI でPR作成
gh pr create \
  --title "<type>: <description>" \
  --body-file pr_body.md \
  --base main \
  --head $(git branch --show-current)

# 8-2. 既存PRの更新
gh pr edit <PR番号> \
  --body-file pr_body.md
```

**オプション**:
- `--reviewer <username>`: レビュアーを自動指定
- `--label <label>`: ラベルを自動付与（例: `ML/AI`, `breaking-change`）
- `--draft`: ドラフトPRとして作成

### 実装上の注意点

1. **エラーハンドリング**:
   - 各ステップで失敗した場合の代替処理を用意
   - 例: implementation_plan.md が存在しない場合はタスク対応セクションをスキップ

2. **トークン効率**:
   - 大きなdiff出力は要約して処理
   - 不要な情報（空白のみの変更等）はフィルタリング

3. **再実行可能性**:
   - 中間結果をキャッシュ（テスト結果、Lint結果）
   - 同じブランチで複数回実行しても冪等性を保つ

4. **セキュリティ**:
   - 機密情報（APIキー、パスワード等）がPR本文に含まれないよう検査
   - diff出力に機密情報が含まれる場合は警告

---

## クイックリファレンス

### PR作成前チェックリスト

- [ ] `git status` でコミット漏れがないか確認
- [ ] `git diff main` でmainとの差分が意図通りか確認
- [ ] コンフリクトがないか確認
- [ ] Lint/テストが通過（`ruff check .`, `pytest`）
- [ ] 必須セクション（変更概要、変更理由、タスク対応、影響範囲、テスト / 検証、リスク / 互換性）を記載
- [ ] ML/AI PRの場合、実験結果セクションを記載
- [ ] `implementation_plan.md` のタスク状態を更新
