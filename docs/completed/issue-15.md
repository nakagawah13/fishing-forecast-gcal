# Issue #15: T-004 潮回り判定サービス

## ステータス
✅ Completed (2026-02-08)

## 概要
大潮・中潮・小潮などの潮回りを判定するドメインサービスを実装する。

## 背景
潮汐情報において、潮回り（TideType）は釣行計画の重要な指標となる。潮位差と月齢から適切に判定するロジックが必要。

## 責務
- 1日の満干潮データ（潮位差）から潮回りを判定
- 月齢情報を考慮した正確な分類
- TideTypeへのマッピング

## 実装方針

### 1. ファイル構成
- **作成**: `src/fishing_forecast_gcal/domain/services/tide_type_classifier.py`
- **テスト**: `tests/unit/domain/services/test_tide_type_classifier.py`

### 2. クラス設計
```python
class TideTypeClassifier:
    """潮回りを判定するドメインサービス"""
    
    @staticmethod
    def classify(tide_range_cm: float, moon_age: float) -> TideType:
        """潮位差と月齢から潮回りを判定
        
        Args:
            tide_range_cm: 潮位差（満潮高さ - 干潮高さ、cm）
            moon_age: 月齢（0-29.5、0=新月、15=満月）
        
        Returns:
            TideType: 判定された潮回り
        """
```

### 3. 判定基準（確定）

#### 月齢による基本判定
- **大潮（SPRING）**: 新月・満月の前後3日（月齢0±3、または15±3）
  - 新月: 0-3日、26.5-29.5日
  - 満月: 12-18日
- **小潮（NEAP）**: 上弦・下弦の前後2日（月齢7±2、または22±2）
  - 上弦: 5-9日
  - 下弦: 20-24日
- **長潮（LONG）**: 上弦・下弦を1〜2日過ぎた頃の小潮末期
  - 上弦後: 8-9日（小潮範囲の後半）
  - 下弦後: 23-24日（小潮範囲の後半）
- **若潮（YOUNG）**: 長潮の翌日
  - 上弦系: 9-10日（長潮の後）
  - 下弦系: 24-25日（長潮の後）
- **中潮（MODERATE）**: 上記以外
  - 大潮と小潮の間の期間

#### 潮位差による補正
月齢判定に加えて、潮位差の大きさで補正を行う：
- 潮位差が大きい場合: より強い潮回り（中潮→大潮など）に補正
- 潮位差が小さい場合: より弱い潮回り（中潮→小潮など）に補正
- 具体的な閾値は実データとの照合で調整

### 4. テスト要件
- **正常系**:
  - 新月（月齢0）→ 大潮
  - 満月（月齢15）→ 大潮
  - 上弦（月齢7）→ 小潮
  - 下弦（月齢22）→ 小潮
  - 中間期 → 中潮
  - 長潮・若潮相当の月齢

- **境界値**:
  - 月齢0付近の境界（29.5 → 0 → 0.5）
  - 各潮回りの境界月齢

- **異常系**:
  - 月齢範囲外（負の値、30以上）
  - 潮位差が負の値

## 変更予定ファイル
- **新規作成**:
  - `src/fishing_forecast_gcal/domain/services/tide_type_classifier.py`
  - `tests/unit/domain/services/test_tide_type_classifier.py`

## 依存タスク
- ✅ T-001: ドメインモデル定義（TideType定義済み）

## 検証計画
1. ユニットテストの実行（pytest）
2. 実際の月齢データとの照合（海上保安庁などの公式データ）
3. 境界値での動作確認

## 課題・要確認事項

### 実装方針（確定）
1. **月齢の入力方法**: 
   - MVP: 外部から引数として渡される（引数として受け取る）
   - 将来: 天文計算ライブラリ（UTide等）との精度比較を行い、精度が良ければライブラリに移行

2. **地域差の考慮**:
   - MVP: 地域差を考慮しない（固定の判定基準）
   - フェーズ2以降: 設定ファイルから閾値を読み込む拡張を検討

### 実装時の課題
1. **潮位差補正の閾値設定**:
   - 実データとの照合で具体的な閾値を決定
   - 初期実装では保守的な閾値でスタート

2. **長潮・若潮の境界**:
   - 小潮範囲（5-9日、20-24日）の中で長潮と小潮を区別
   - 月齢ではなく潮位差の変化率も考慮する可能性

## 参照
- [implementation_plan.md - T-004](../implementation_plan.md#t-004-潮回り判定サービス)
- [tide.py - TideType定義](../../src/fishing_forecast_gcal/domain/models/tide.py)

---

## 実装結果・変更点

### 実装ファイル
✅ **作成完了** (2026-02-08)
- `src/fishing_forecast_gcal/domain/services/tide_type_classifier.py` (119行)
- `tests/unit/domain/services/test_tide_type_classifier.py` (129行)

### 実装内容

#### TideTypeClassifierクラス
- **責務**: 潮位差と月齢から潮回り（TideType）を判定
- **メソッド**: `classify(tide_range_cm, moon_age) -> TideType`

#### 判定ロジック
1. **月齢による基本判定** (`_classify_by_moon_age`):
   - 大潮（SPRING）: 0-3日、12-18日、26.5-29.5日
   - 小潮（NEAP）: 5-8日、20-23日
   - 長潮（LONG）: 8-9日、23-24日（小潮末期）
   - 若潮（YOUNG）: 9-10日、24-25日（長潮の翌日）
   - 中潮（MODERATE）: その他の期間

2. **潮位差による補正** (`_adjust_by_tide_range`):
   - 潮位差 ≥ 180cm: 中潮 → 大潮に昇格
   - 潮位差 < 80cm: 大潮 → 中潮に降格

3. **入力バリデーション**:
   - `tide_range_cm` ≥ 0（負の値でエラー）
   - 0 ≤ `moon_age` ≤ 29.5（範囲外でエラー）

### テスト結果
✅ **全テストパス** (23件)
- ユニットテスト: 23件（100%パス）
- カバレッジ: 100%

#### テストケース
- 新月・満月周りの大潮判定（6件）
- 上弦・下弦周りの小潮判定（4件）
- 長潮・若潮の判定（4件）
- 中潮の判定（2件）
- 境界値テスト（2件）
- 潮位差による補正（2件）
- 入力バリデーション（3件）

### 品質チェック
✅ **全てパス** (2026-02-08)
- `uv run ruff format .`: 変更なし
- `uv run ruff check .`: All checks passed
- `uv run pyright`: 0 errors, 0 warnings
- `uv run pytest`: 98件パス（全体）

### コミット
1. `a9e7a3e`: test: add TideTypeClassifier unit tests
2. `45e712b`: feat: implement TideTypeClassifier domain service

### 今後の課題・改善点
1. **実データとの検証**:
   - 海上保安庁などの公式潮汐表と比較して判定精度を確認
   - 潮位差補正の閾値（180cm、80cm）を実データに基づいて調整

2. **月齢計算の検討**:
   - MVP以降、天文計算ライブラリ（UTide等）との精度比較
   - 必要に応じて月齢計算機能を内部実装

3. **地域差への対応**:
   - フェーズ2以降、設定ファイルから閾値を読み込む拡張を検討
   - 地域ごとの潮汐特性を考慮した判定基準のカスタマイズ

4. **長潮・若潮の精度向上**:
   - 潮位差の変化率を考慮した判定ロジックの追加
   - 連続する日の潮位差を比較して動的に判定
