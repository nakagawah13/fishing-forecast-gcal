# Requirements

## ユースケース

### ペルソナ1: 週末アングラー（佐藤さん）
**プロフィール**:
- 平日は会社員、土日のみ釣行可能
- 金曜夜に翌週末の釣行計画を立てる
- 大潮・中潮の日を狙いたい

**典型的な利用シナリオ**:
1. 金曜20:00 - Google カレンダーを開き、翌土日の潮汐を確認
2. 大潮であれば満潮時刻をチェック
3. 金曜23:00 - 最新の週末天気予報（風速・風向）を確認
4. 土曜朝05:00 - 当日の最新予報を再確認してから出発判断

**求める情報**:
- 潮回り（大潮/中潮判定）
- 満潮・干潮時刻
- 時合い帯（満潮±2時間）
- 風速・風向の予報値（更新：前日夜〜当日朝）

**更新頻度の要求**:
- 天文潮: 月初に1ヶ月先まで登録されていれば十分
- 予報: 金曜夜と土曜朝に最新情報が必要（6時間更新で対応可能）

---

### ペルソナ2: 早朝アングラー（田中さん）
**プロフィール**:
- 平日も朝5:00-7:00に釣行
- 前日夜に翌朝の釣行可否を判断
- 風速10m/s以上は中止

**典型的な利用シナリオ**:
1. 火曜21:00 - 翌朝（水曜）の潮汐と予報を確認
2. 満潮時刻が6:00前後で風速5m/s以下なら釣行決定
3. 水曜04:30 - 起床後、念のため最新予報を再確認

**求める情報**:
- 満潮時刻（早朝5:00-7:00の範囲か）
- 風速の予報値（10m/s未満が条件）
- 気圧の変化（魚の活性指標として参照）

**更新頻度の要求**:
- 予報: 前日21:00と当日04:30に最新情報が必要
- 気象庁の予報更新が3時間ごと → 6時間更新では不足の可能性
- **結論**: 3時間ごとの更新が望ましい

---

### ペルソナ3: 遠征計画者（鈴木さん）
**プロフィール**:
- 年4回、遠方への釣行遠征を計画
- 1-2ヶ月前に大潮の日程を確定したい
- 宿泊・交通手段の予約との兼ね合いで早期確定が必要

**典型的な利用シナリオ**:
1. 1月1日 - 3月の大潮期間を確認（カレンダーで一覧表示）
2. 1月5日 - 3月10-12日（大潮3日間）を遠征候補として別カレンダーに登録
3. 2月中旬 - 遠征1ヶ月前に天気傾向を確認（長期予報）
4. 3月8日 - 遠征2日前に最新予報で最終判断

**求める情報**:
- 1-3ヶ月先の潮回りカレンダー
- 大潮期間の可視化（連続3日間が理想）
- 遠征候補地の潮汐（複数地点の比較）

**機能要求**:
- 長期潮汐データ（3ヶ月〜1年先）の事前登録
- 複数地点の潮汐を別カレンダーに登録（MVP外）
- 遠征用カレンダーへの手動イベント追加との共存（MVP以降で検討）

---

## ユースケース分析による検証結果

### 更新頻度の妥当性

| 更新対象 | 現行設定 | 妥当性評価 | 根拠 |
|---------|---------|-----------|------|
| 天文潮（Sync-Tide） | 月次 | ✅ 妥当 | 天文潮は変化しないため、長期登録で十分 |
| 予報（Sync-Weather） | 3時間ごと | ✅ 妥当 | 気象庁は3時間ごと更新。早朝判断の頻度要件に一致 |
| 予報対象期間 | 7日先まで | ✅ 妥当 | 週末アングラーの金曜確認、早朝アングラーの当日確認に対応 |
| 天文潮登録期間 | 1年先まで | ✅ 妥当 | 遠征計画（1-3ヶ月前）に対応可能 |

**補足事項**:
- 早朝時間帯（4:00-7:00）は更新頻度を上げる（優先度高）
- 設定ファイルで `update_interval_hours` をカスタマイズ可能にする

### 機能の妥当性

| 機能 | 優先度 | 備考 |
|-----|--------|------|
| 満潮・干潮時刻の算出 | 必須 | 全ペルソナで必要 |
| 潮回り判定 | 必須 | 週末・遠征計画で重要 |
| 時合い帯の表示 | 推奨 | 満潮±2時間を明示すると利便性向上 |
| 風速・風向予報 | 必須 | 釣行可否判断の最重要指標 |
| 気圧情報 | 推奨 | 魚の活性判断に有用（フェーズ2で追加） |
| 複数地点対応 | MVP外 | 遠征計画で有用だが、運用コスト高 |
| タイドグラフ画像 | MVP外 | 視覚的だが、テキスト情報で代替可能 |

---

## 機能要件
- 指定期間の天文潮を取得し、満潮・干潮時刻を算出する
- 潮回り（大潮・中潮・小潮など）を付与する
- Google カレンダーにイベントを作成する
- 直前更新で風速などの予報情報をイベントに追記する
- 時合い帯（満潮±2時間）を計算し、イベント本文に記載する（推奨）

## 非機能要件
- 自動バッチ実行に耐える再実行性
- API 制限を考慮したスロットリング
- 失敗時のリトライと通知
- 設定ファイルによる地点・期間の切替
- 構造化ログ（JSON形式）による実行状況の記録

## 既知の制約
- 天文潮は長期予測可能だが、気象潮は短期予報に依存
- 画像の埋め込みは Google カレンダー仕様に合わせる必要がある（MVP では扱わない）

## 設定ファイル方針（MVP）
- 形式: `config/config.yaml`
- 地点: ホーム 1 地点のみ
- 目的: UI を作らずに運用可能にする（設定変更で対応）
- 遠征対応: MVP 以降で検討
- `config/config.yaml` は Git 管理しない（居住地情報の漏洩を避ける）
- `config/config.yaml.template` をコミットし、テンプレート運用とする
- Google Calendar の OAuth 認証情報とトークンは `settings` のパス指定で読み込む
- Google アカウントの個人情報は設定ファイルに含めない（OAuth のクレデンシャルとトークンのみで運用）
- `locations.id` は不変IDとして扱い、表示名（`name`）の変更でイベントIDが変わらないようにする

## 設定ファイルスキーマ（MVP）
```yaml
settings:
  timezone: "Asia/Tokyo"
  update_interval_hours: 3  # 変更: 6 → 3（気象庁の更新頻度に合わせる）
  forecast_window_days: 7
  tide_register_months: 12  # 追加: 天文潮を何ヶ月先まで登録するか
  high_priority_hours: [4, 5, 6, 7, 20, 21, 22, 23]  # 追加: 優先更新時間帯
  google_credentials_path: "config/credentials.json"  # OAuth クライアント情報
  google_token_path: "config/token.json"  # OAuth トークン保存先
  calendar_id: "your_fishing_calendar_id@group.calendar.google.com"

locations:
  - id: "loc_home"
    name: "Home"
    latitude: 35.0000
    longitude: 139.0000
    port_code: "PLACEHOLDER"

fishing_conditions:  # 追加: 釣行判断の閾値設定
  prime_time_offset_hours: 2  # 満潮前後の時合い帯
  max_wind_speed_ms: 10  # 釣行中止の風速閾値
  preferred_tide_types: ["大潮", "中潮"]  # 優先する潮回り
```

## イベント設計（MVP）
- 種別: 終日イベント（`settings.timezone` の日付基準）
- タイトル: `潮汐 {location_name} ({tide_type})`
- 本文構造: 予報更新の差分反映を前提に、セクションを明示的に区切る

本文フォーマット（例）:
```
[TIDE]
- 満潮: 06:12 (162cm)
- 干潮: 12:34 (58cm)
- 時合い: 04:12-08:12

[FORECAST]
- 風速: 5m/s
- 風向: 北
- 気圧: 1012hPa

[NOTES]
- 手動メモ（ここは自動更新で保持）
```

- 更新方針:
  - Sync-Tide はタイトルと `[TIDE]` を更新（予報・メモは保持）
  - Sync-Weather は `[FORECAST]` のみ更新（他セクションは保持）
- ユーザー編集は `[NOTES]` のみを対象とし、セクション名は変更しない
- 破損対策: セクションが欠落している場合は自動更新をスキップし、ログで警告する（メモ保護を優先）
- イベント ID 生成: `calendar_id + location_id + date` を素材に安定ハッシュで生成

## 決定事項（MVP）
- イベントはテキストのみで運用し、画像は後続フェーズで検討
- 終日イベント + 説明文に詳細時刻を集約（視認性を優先）
- 天文潮の取得は合法性と継続性を優先し、ライセンス確認後に決定
- 計算ライブラリ採用時は公式潮見表で差分検証を行う
- 時合い帯の既定は「満潮前後 2 時間」
- 予報更新は `forecast_window_days` の範囲のみを対象にする
- イベント ID は安定したハッシュで生成する（詳細は実装計画に従う）
- MVP では遠征カレンダー（trips）の運用を扱わない
- 釣行可否は二値判定ではなく注意レベル表示を基本とする（Safe/Warning/Danger）

## MVP以降の検討事項
- 時合い帯を時間指定イベントとして可視化する（別カレンダー運用も含む）
- `extendedProperties` に管理タグや更新ハッシュを保持し、破損検知と差分更新を強化する
- 設定から外れた地点の未来イベントを削除するガベージコレクション方針を追加する
- 予報値の差分がない場合は更新をスキップし、API呼び出し量を抑える

## 未決事項
- 公式/準公式データの入手可否と利用規約
- 潮回り（大潮/中潮/小潮など）を含むデータソースの採用可否

## 落とし穴・注意点
- 潮汐データの取得方式により、精度・継続性・料金が大きく変わる
- カレンダー更新は差分更新の設計次第で重複登録が起こりやすい
- 多地点・高頻度更新ではAPIクォータに抵触する可能性があるため、差分更新や更新スキップが重要
- 複数地点対応は運用コストとイベント数が急増するため、MVP では避ける
- 設定ファイルを Git 管理すると、居住地情報が漏洩する可能性がある
- 非公式 API やスクレイピングは規約違反や停止のリスクがある
- 時刻イベントはカレンダーの視認性と API 負荷を悪化させるため、MVP では終日イベントのみ
