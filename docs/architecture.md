# Architecture

## 目的
- 潮汐（天文潮）を元に、満潮・干潮時刻と潮回りを Google カレンダーへ登録
- タイドグラフ画像を生成し、カレンダーへ埋め込み
- 直前の予報値（風速など）を自動更新できる仕組みを備える

## 主要コンポーネント
1. Tide Data Provider
   - 天文潮計算または外部 API から潮汐データを取得
2. Weather Provider
   - 風速・風向・気圧などの予報値を取得
3. Calendar Sync
   - Google カレンダーにイベント作成・更新（画像は後続フェーズ）
4. Scheduler
   - 初回一括登録と、直前更新のバッチ実行
5. Config Loader
   - `config/config.yaml` を読み込み設定を供給

## データフロー（概要）
- 天文潮データ取得 → 満干潮時刻・潮回り算出（グラフ生成は後続フェーズ）
- Google カレンダーイベント作成（MVP は画像なし）
- 直前更新時に風速などを追記してイベント更新

## 更新ポリシー
- Sync-Tide（月次）:
   - 対象: 今日〜1年後
   - 内容: 天文潮イベントを作成/更新
- Sync-Weather（6時間ごと）:
   - 対象: 今日〜`forecast_window_days`
   - 内容: 予報情報を本文の予報セクションに反映

## 非機能要件（概要）
- API 失敗時のリトライ
- 予報値更新の差分更新
- ログと再実行性

## MVP のイベント設計（たたき台）
- タイトル: `潮汐 | {地点名}`
- 日時: 終日イベント（詳細時刻は説明文に記載）
- 本文: 満潮/干潮時刻、潮回り、更新日時
- タイムゾーン: 設定ファイルで固定（デフォルトは `Asia/Tokyo`）
- 更新方針: イベント ID を保持し、同一キーで差分更新
- 通知: 既定はオフ（必要ならユーザーが有効化）

本文の更新方針:
- 自動生成セクションを分離し、その範囲のみを上書き
- セパレーター例: `=== AUTO GENERATED BELOW ===`

本文テンプレ（例）:
```
満潮: 05:12 / 17:44
干潮: 11:33 / 23:58
潮回り: 大潮
更新: 2026-02-07 09:00
```

イベントキー（例）:
- `{日付}_{地点名}_{タイプ}`
   - `20251027_Kawasaki_daily`

将来拡張の方針:
- 満干潮の時刻イベントは別カレンダーに分離（レイヤー運用）
- 点イベントではなく「時合い」帯で登録する（満潮前後 2 時間）

## 冪等性方針（重複防止）
- イベント ID を日付 + 地点から決定し、同一 ID で upsert
- Google カレンダー API の ID 制約に合わせ、文字種/長さを正規化
- 実装は `md5({date}_{location}_{type}).hexdigest()` を基本案とする
- 失敗時の復旧用に `extendedProperties` へキーを保存
